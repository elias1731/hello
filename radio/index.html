<!DOCTYPE html>
<html lang="de">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
	<title>ğŸ—¿Â» ğ“•ğ“¸ğ“»ğ“­ğ”‚â€¢Radio</title>
	
	<link rel="manifest" href="manifest.json">
	<meta name="theme-color" content="#1e1e1e">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<link rel="apple-touch-icon" href="./assets/app.png">
	
	<link rel="apple-touch-startup-image" href="./assets/app.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="./assets/splash/iPhone_11__iPhone_XR_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 420px) and (device-height: 912px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="./assets/splash/iPhone_Air_portrait.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 402px) and (device-height: 874px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="./assets/splash/iPhone_17_Pro__iPhone_17__iPhone_16_Pro_portrait.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="./assets/splash/10.2__iPad_portrait.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="./assets/splash/12.9__iPad_Pro_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="./assets/splash/iPhone_11__iPhone_XR_portrait.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="./assets/splash/11__iPad_Pro__10.5__iPad_Pro_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 440px) and (device-height: 956px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="./assets/splash/iPhone_17_Pro_Max__iPhone_16_Pro_Max_portrait.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="./assets/splash/4__iPhone_SE__iPod_touch_5th_generation_and_later_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1210px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="./assets/splash/11__iPad_Pro_M4_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="./assets/splash/iPhone_14_Plus__iPhone_13_Pro_Max__iPhone_12_Pro_Max_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="./assets/splash/iPhone_16e__iPhone_14__iPhone_13_Pro__iPhone_13__iPhone_12_Pro__iPhone_12_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="./assets/splash/iPhone_13_mini__iPhone_12_mini__iPhone_11_Pro__iPhone_XS__iPhone_X_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="./assets/splash/iPhone_14_Plus__iPhone_13_Pro_Max__iPhone_12_Pro_Max_portrait.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1210px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="./assets/splash/11__iPad_Pro_M4_portrait.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="./assets/splash/iPhone_16e__iPhone_14__iPhone_13_Pro__iPhone_13__iPhone_12_Pro__iPhone_12_portrait.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 820px) and (device-height: 1180px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="./assets/splash/10.9__iPad_Air_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="./assets/splash/4__iPhone_SE__iPod_touch_5th_generation_and_later_portrait.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="./assets/splash/12.9__iPad_Pro_portrait.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="./assets/splash/iPhone_8__iPhone_7__iPhone_6s__iPhone_6__4.7__iPhone_SE_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 1032px) and (device-height: 1376px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="./assets/splash/13__iPad_Pro_M4_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 1032px) and (device-height: 1376px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="./assets/splash/13__iPad_Pro_M4_portrait.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 402px) and (device-height: 874px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="./assets/splash/iPhone_17_Pro__iPhone_17__iPhone_16_Pro_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="./assets/splash/iPhone_11_Pro_Max__iPhone_XS_Max_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="./assets/splash/iPhone_13_mini__iPhone_12_mini__iPhone_11_Pro__iPhone_XS__iPhone_X_portrait.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 420px) and (device-height: 912px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="./assets/splash/iPhone_Air_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="./assets/splash/iPhone_11_Pro_Max__iPhone_XS_Max_portrait.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="./assets/splash/iPhone_8__iPhone_7__iPhone_6s__iPhone_6__4.7__iPhone_SE_portrait.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="./assets/splash/iPhone_16_Plus__iPhone_15_Pro_Max__iPhone_15_Plus__iPhone_14_Pro_Max_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="./assets/splash/8.3__iPad_Mini_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="./assets/splash/8.3__iPad_Mini_portrait.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="./assets/splash/11__iPad_Pro__10.5__iPad_Pro_portrait.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="./assets/splash/9.7__iPad_Pro__7.9__iPad_mini__9.7__iPad_Air__9.7__iPad_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="./assets/splash/iPhone_16__iPhone_15_Pro__iPhone_15__iPhone_14_Pro_portrait.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="./assets/splash/iPhone_16__iPhone_15_Pro__iPhone_15__iPhone_14_Pro_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="./assets/splash/iPhone_8_Plus__iPhone_7_Plus__iPhone_6s_Plus__iPhone_6_Plus_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="./assets/splash/10.5__iPad_Air_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="./assets/splash/iPhone_8_Plus__iPhone_7_Plus__iPhone_6s_Plus__iPhone_6_Plus_portrait.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 820px) and (device-height: 1180px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="./assets/splash/10.9__iPad_Air_portrait.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="./assets/splash/10.2__iPad_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="./assets/splash/10.5__iPad_Air_portrait.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 440px) and (device-height: 956px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="./assets/splash/iPhone_17_Pro_Max__iPhone_16_Pro_Max_landscape.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="./assets/splash/9.7__iPad_Pro__7.9__iPad_mini__9.7__iPad_Air__9.7__iPad_portrait.png">
	<link rel="apple-touch-startup-image" media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="./assets/splash/iPhone_16_Plus__iPhone_15_Pro_Max__iPhone_15_Plus__iPhone_14_Pro_Max_portrait.png">

	<link rel="icon" type="image/png" href="../assets/icon.png">
	<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link rel="stylesheet" href="../assets/style.css">
	<link rel="stylesheet" href="assets/style.css">
</head>
<body id="app-body">

	<div id="dynamic-bg"></div>

	<header>
		<div class="header-brand">
			<i class="fa-solid fa-radio" style="margin-right: 10px;"></i>
			<span class="rainbow-text"> Â» ğ“±ğ“®ğ”‚ğ“•ğ“¸ğ“»ğ“­ğ”‚.de ğ—¥ğ—®ğ—±ğ—¶Î¿</span>
		</div>
		<div class="header-actions">
			<button onclick="openSettings()" class="round-btn"><i class="fa-solid fa-gear"></i></button>
		</div>
	</header>

	<main>
		<div class="content-box player-container">
			<div class="cover-art-wrapper">
				<img id="player-img" src="./assets/app.png" alt="Station Logo" crossorigin="anonymous">
				<img id="player-overlay-logo" class="station-logo-overlay" src="" alt="Station Overlay">
			</div>
			
			<div id="player-title">ğ“•ğ“¸ğ“»ğ“­ğ”‚â€¢ğ—¥ğ—®ğ—±ğ—¶ğ—¼</div>
			<div id="player-artist"></div>
			
			<div id="player-status">â—½ï¸ BEREIT</div>
			
			<audio id="audio-el" preload="none"></audio>

			<div class="controls">
				<button onclick="toggleMute()" class="round-btn secondary-ctrl"><i id="mute-icon" class="fa-solid fa-volume-high"></i></button>
				<button onclick="togglePlay()" class="play-btn">
					<i id="play-icon" class="fa-solid fa-play"></i>
				</button>
				<button onclick="skipNext()" class="round-btn secondary-ctrl"><i class="fa-solid fa-forward-step"></i></button>
			</div>
		</div>
	</main>

	<footer id="main-footer">
		<div class="footer-header" onclick="toggleFooter()">
			<span>SENDERLISTE</span>
			<span id="footer-arrow">â–²</span>
		</div>
		<div class="footer-content" id="footer-list"></div>
		<div class="footer-link-wrapper">
			<button onclick="openManager()" class="manage-btn">ğŸ§° Sender verwalten</button>
		</div>
	</footer>

	<div id="settings-modal" class="modal">
		<div class="modal-content">
			<button class="modal-close-btn-x" onclick="closeSettings()">X</button>
			<h3 class="modal-title">Einstellungen</h3>
			
			<div class="switch-container">
				<span class="switch-label">Letzten Sender merken</span>
				<label class="switch">
					<input type="checkbox" id="autoplay-toggle" onchange="saveSettings()">
					<span class="slider"></span>
				</label>
			</div>

			<div class="switch-container">
				<span class="switch-label">iTunes Album Cover laden</span>
				<label class="switch">
					<input type="checkbox" id="itunes-toggle" onchange="saveSettings()">
					<span class="slider"></span>
				</label>
			</div>

			<button onclick="clearCache()" class="clear-cache-btn">
				<i class="fa-solid fa-trash-can"></i> Cache leeren & Reload
			</button>
		</div>
	</div>

	<div id="manager-modal" class="modal">
		<div class="modal-content">
			<button class="modal-close-btn-x" onclick="closeManager()">X</button>
			<h3 class="modal-title">Sender verwalten</h3>
			
			<div id="settings-list" class="manager-list"></div>
			
			<div class="add-station-box">
				<h4>Sender hinzufÃ¼gen</h4>
				<div class="tabs">
					<button class="tab-btn active" onclick="switchTab('search')">Suche</button>
					<button class="tab-btn" onclick="switchTab('manual')">Manuell</button>
				</div>

				<div id="tab-search" class="tab-content active">
					<input type="text" id="search-query" placeholder="Sender suchen..." oninput="debounceSearch()">
					<div id="search-results"></div>
				</div>

				<div id="tab-manual" class="tab-content">
					<input type="text" id="new-name" placeholder="Name (Liste)">
					<input type="text" id="new-displayname" placeholder="Name (Player)">
					<input type="text" id="new-url" placeholder="Stream URL">
					<input type="text" id="new-logo" placeholder="Logo URL (optional)">
					<input type="text" id="new-art" placeholder="Live Artwork URL (optional)">
					<input type="text" id="new-info" placeholder="Info URL (optional)">
					<div style="text-align: right; margin-top: 10px;">
						<button onclick="addStationManual()" class="modal-btn save">Speichern</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<canvas id="color-canvas" style="display:none;"></canvas>

	<script>
		// --- Service Worker ---
		if ('serviceWorker' in navigator) {
			navigator.serviceWorker.register('sw.js').then(() => console.log('SW Registered'));
		}

		// --- State ---
		const defaultStations = [
			{ isDefault: true, name: "Eldoradio ğŸ‡±ğŸ‡º", displayName: "E L D O", apiId: "eldoradio", url: "https://sc.bce.lu/eldo", logo: "https://heyfordy.de/radio/assets/eldo.lu.png" },
			{ isDefault: true, name: "RADIO BOB! â€¢ NationalğŸ¤˜", displayName: "RADIO BOB!", apiId: "radio-bob", url: "https://streams.radiobob.de/bob-national/mp3-320/mediaplayer", logo: "https://heyfordy.de/radio/assets/radio-bob.png" },
			{ isDefault: true, name: "RTL Luxemburg ğŸ‡±ğŸ‡º", displayName: "RTL.lu", apiId: "rtl.lu", url: "https://sc.bce.lu/rtl", logo: "https://heyfordy.de/radio/assets/rtl.lu.png" },
			{ isDefault: true, name: "Rockland Radio â€¢ Trier", displayName: "ROCKLAND", apiId: "rockland", url: "https://streams.rockland.de/trier/mp3-192/direkt/", logo: "https://heyfordy.de/radio/assets/rockland.png" },
			{ isDefault: true, name: "Sunshine LIVEâ˜€ï¸", displayName: "SUNSHINE LIVE", apiId: "sunsl-sslsimulcast-mp3-192-4434053", url: "https://sunsl.streamabc.net/sunsl-sslsimulcast-mp3-192-4434053", logo: "https://heyfordy.de/radio/assets/sunshine.png" },
			{ isDefault: true, name: "Sunshine EurodanceğŸª©", displayName: "SUNSHINE EURODANCE", apiId: "sunsl-eurodance-mp3-192-9832422", url: "https://sunsl.streamabc.net/sunsl-eurodance-mp3-192-9832422", logo: "https://heyfordy.de/radio/assets/sunshine-eurodance.png" },
			{ isDefault: true, name: "RADIO ENERGY âš¡ï¸", displayName: "RADIO NRJ", apiId: "energy-digital", url: "https://edge24.streamonkey.net/energy-digital?aggregator=energy-digital", logo: "https://heyfordy.de/radio/assets/nrj.png" }
		];

		let stations = JSON.parse(localStorage.getItem('radio_stations')) || defaultStations;
		let rememberLastStation = JSON.parse(localStorage.getItem('radio_remember')) || false;
		let itunesEnabled = JSON.parse(localStorage.getItem('radio_itunes_enabled')) !== false; 
		let lastPlayedIndex = parseInt(localStorage.getItem('radio_last_index')) || 0;
		
		let currentStationIndex = -1;
		let metaInterval = null;
		let searchTimeout = null;
		let lastTrackRaw = ""; 
		let footerOpen = false;
		let currentCoverUrl = './assets/app.png';

		const audio = document.getElementById('audio-el');

		// --- Initialization ---
		renderStations();
		document.getElementById('autoplay-toggle').checked = rememberLastStation;
		document.getElementById('itunes-toggle').checked = itunesEnabled;
		resetBackgroundToDefault();
		handleStartup();

		// --- Audio Events ---
		audio.addEventListener('playing', () => {
			updateStatus("playing");
			updatePlayBtn(true);
		});
		audio.addEventListener('pause', () => {
			updateStatus("ready");
			updatePlayBtn(false);
			resetToStationView();
		});
		audio.addEventListener('error', () => {
			updateStatus("error");
			updatePlayBtn(false);
		});

		// --- App Logic ---
		function handleStartup() {
			const urlParams = new URLSearchParams(window.location.search);
			const playParam = urlParams.get('play');

			if (playParam) {
				let idx = stations.findIndex(s => s.apiId === playParam);
				if (idx !== -1) playStation(idx);
			} else if (rememberLastStation && lastPlayedIndex >= 0 && lastPlayedIndex < stations.length) {
				currentStationIndex = lastPlayedIndex;
				resetToStationView();
				updateStatus("ready");
			}
		}

		function playStation(index) {
			currentStationIndex = index;
			localStorage.setItem('radio_last_index', index);
			const s = stations[index];
			
			toggleFooter(false);
			updateStatus("loading");
			updatePlayBtn(true);

			hideOverlayLogo();
			lastTrackRaw = ""; 
			currentCoverUrl = s.logo || './assets/app.png';
			resetBackgroundToDefault();
			changeCover(currentCoverUrl);

			document.querySelectorAll('.station-item').forEach((el, i) => el.classList.toggle('active', i === index));

			audio.src = s.url;
			audio.play().then(() => startMetaFetcher(s)).catch(() => {
				updatePlayBtn(false);
				updateStatus("ready"); 
			});
		}

		function togglePlay() {
			if (currentStationIndex === -1) return;
			if (audio.paused || !audio.src) {
				playStation(currentStationIndex);
			} else {
				audio.pause();
				audio.src = ""; // Force disconnect to stop data transfer
				updateStatus("ready");
				updatePlayBtn(false);
				resetToStationView();
			}
		}

		function skipNext() {
			let next = (currentStationIndex + 1) % stations.length;
			playStation(next);
		}

		function toggleMute() {
			audio.muted = !audio.muted;
			document.getElementById('mute-icon').className = audio.muted ? 'fa-solid fa-volume-xmark' : 'fa-solid fa-volume-high';
		}

		function resetToStationView() {
			if (currentStationIndex === -1) return;
			const s = stations[currentStationIndex];
			document.getElementById('player-title').innerText = s.name;
			document.getElementById('player-artist').innerText = "";
			changeCover(s.logo || './assets/app.png');
			hideOverlayLogo();
			updateMediaSession(s.name, "ğŸ—¿Â» ğ“•ğ“¸ğ“»ğ“­ğ”‚â€¢ğ—¥ğ—®ğ—±ğ—¶Î¿", s.logo);
		}

		function updateStatus(state) {
			const el = document.getElementById('player-status');
			const map = {
				"ready": "â—½ï¸ BEREIT",
				"loading": "ğŸ”¸ STREAM WIRD GELADENâ€¦",
				"playing": "â–¶ï¸ WIEDERGABE LÃ„UFT",
				"error": "âš ï¸ FEHLER"
			};
			el.innerText = map[state] || map["ready"];
		}

		function updatePlayBtn(isPlaying) {
			document.getElementById('play-icon').className = isPlaying ? 'fa-solid fa-stop' : 'fa-solid fa-play';
		}

		// --- Meta Handling ---
		function startMetaFetcher(station) {
			if (metaInterval) clearInterval(metaInterval);
			const fetchInfo = () => {
				if (audio.paused || !audio.src) return;
				
				if (station.apiId) {
					fetch('https://api.heyfordy.de/radio').then(r=>r.json()).then(d => {
						const sd = d.find(i => i.id === station.apiId);
						handleStationData(station, sd?.playing, sd?.art || station.liveArt, sd?.logo || station.logo);
					}).catch(() => handleStationData(station, null, station.liveArt, station.logo));
				} else {
					handleStationData(station, null, station.liveArt, station.logo);
				}
			};
			fetchInfo();
			metaInterval = setInterval(fetchInfo, 10000);
		}

		function handleStationData(station, rawTitle, apiArt, fallbackLogo) {
			if (audio.paused || !audio.src) return;
			if (rawTitle === lastTrackRaw) return;
			lastTrackRaw = rawTitle;

			if (!rawTitle) {
				document.getElementById('player-title').innerText = station.name;
				document.getElementById('player-artist').innerText = "";
				updateCoverAndSession(fallbackLogo, station.name, station.displayName + " | ğ“•ğ“¸ğ“»ğ“­ğ”‚â€¢ğ—¥ğ—®ğ—±ğ—¶Î¿", false);
			} else {
				document.getElementById('player-title').innerText = rawTitle;
				document.getElementById('player-artist').innerText = station.displayName;
				
				if (apiArt) {
					updateCoverAndSession(apiArt, rawTitle, station.displayName + " | ğ“•ğ“¸ğ“»ğ“­ğ”‚â€¢ğ—¥ğ—®ğ—±iÎ¿", true, station.logo);
				} else if (itunesEnabled) {
					fetchItunesCover(rawTitle, fallbackLogo).then(cUrl => {
						const isItunes = cUrl !== fallbackLogo;
						updateCoverAndSession(cUrl, rawTitle, station.displayName + " | ğ“•ğ“¸ğ“»ğ“­ğ”‚â€¢ğ—¥ğ—®ğ—±iÎ¿", isItunes, station.logo);
					});
				} else {
					updateCoverAndSession(fallbackLogo, rawTitle, station.displayName + " | ğ“•ğ“¸ğ“»ğ“­ğ”‚â€¢ğ—¥ğ—®ğ—±iÎ¿", false);
				}
			}
		}

		function updateCoverAndSession(coverUrl, title, sessionArtist, showOverlay, overlayLogoUrl) {
			const finalCover = coverUrl || './assets/app.png';
			currentCoverUrl = finalCover;
			changeCover(finalCover);
			
			const overlayEl = document.getElementById('player-overlay-logo');
			if (showOverlay && overlayLogoUrl && coverUrl !== overlayLogoUrl) {
				overlayEl.src = overlayLogoUrl;
				overlayEl.style.display = 'block';
			} else {
				hideOverlayLogo();
			}
			
			setTimeout(extractAndApplyColor, 1000);
			updateMediaSession(title, sessionArtist, finalCover);
		}

		function changeCover(newSrc) {
			const img = document.getElementById('player-img');
			img.style.opacity = 0;
			setTimeout(() => {
				img.src = newSrc;
				img.onload = () => { img.style.opacity = 1; };
			}, 400); 
		}

		function hideOverlayLogo() { document.getElementById('player-overlay-logo').style.display = 'none'; }

		// --- Graphics ---
		function resetBackgroundToDefault() {
			document.getElementById('dynamic-bg').style.background = `radial-gradient(circle at 50% 50%, rgba(255, 100, 0, 0.4), transparent 80%), linear-gradient(135deg, #1a1a1a 0%, #000 100%)`;
		}

		function extractAndApplyColor() {
			const img = document.getElementById('player-img');
			const canvas = document.getElementById('color-canvas');
			const ctx = canvas.getContext('2d');
			try {
				canvas.width = 50; canvas.height = 50;
				ctx.drawImage(img, 0, 0, 50, 50);
				const p = ctx.getImageData(10, 10, 1, 1).data;
				document.getElementById('dynamic-bg').style.background = `radial-gradient(circle at 30% 30%, rgba(${p[0]}, ${p[1]}, ${p[2]}, 0.7), transparent 70%), linear-gradient(to bottom, #1a1a1a, #000)`;
			} catch(e) { resetBackgroundToDefault(); }
		}

		async function fetchItunesCover(term, fallback) {
			try {
				const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=song&limit=1`);
				const data = await res.json();
				if(data.resultCount>0) return data.results[0].artworkUrl100.replace('100x100bb','512x512bb');
			} catch(e){}
			return fallback;
		}

		function updateMediaSession(t, a, i) {
			if('mediaSession' in navigator) {
				navigator.mediaSession.metadata = new MediaMetadata({ title:t, artist:a, artwork:[{src:i||'./assets/app.png', sizes:'512x512', type:'image/png'}] });
			}
		}

		// --- UI Interaction ---
		function toggleFooter(force) {
			footerOpen = (force !== undefined) ? force : !footerOpen;
			const footer = document.getElementById('main-footer');
			footer.classList.toggle('expanded', footerOpen);
			document.getElementById('footer-arrow').innerText = footerOpen ? 'â–¼' : 'â–²';
		}

		function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
		function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
		
		function openManager() { 
			renderManagerList();
			document.getElementById('manager-modal').style.display = 'flex'; 
		}
		function closeManager() { document.getElementById('manager-modal').style.display = 'none'; }

		function renderStations() {
			const list = document.getElementById('footer-list');
			list.innerHTML = '';
			stations.forEach((s, i) => {
				list.innerHTML += `
					<div class="station-item ${i === currentStationIndex ? 'active' : ''}" onclick="playStation(${i})">
						<img src="${s.logo || './assets/app.png'}" class="station-logo" onerror="this.src='./assets/app.png'">
						<div class="station-info"><span>${s.name}</span></div>
						<i class="fa-solid fa-play" style="opacity:0.3;"></i>
					</div>
				`;
			});
		}

		function renderManagerList() {
			const list = document.getElementById('settings-list');
			list.innerHTML = '';
			stations.forEach((s, i) => {
				list.innerHTML += `
					<div class="settings-item">
						<div style="flex:1;"><strong>${s.name}</strong></div>
						<div class="manager-ctrls">
							<i class="fa-solid fa-arrow-up action-icon" onclick="moveStation(${i},-1)"></i>
							<i class="fa-solid fa-arrow-down action-icon" onclick="moveStation(${i},1)"></i>
							${!s.isDefault ? `<i class="fa-solid fa-trash action-icon delete-icon" onclick="removeStation(${i})"></i>` : '<i class="fa-solid fa-lock" style="opacity:0.2"></i>'}
						</div>
					</div>
				`;
			});
		}

		function moveStation(idx, dir) {
			let nIdx = idx + dir;
			if (nIdx < 0 || nIdx >= stations.length) return;
			[stations[idx], stations[nIdx]] = [stations[nIdx], stations[idx]];
			saveAndRefresh();
		}

		function removeStation(idx) {
			if(confirm("Sender wirklich lÃ¶schen?")) { stations.splice(idx, 1); saveAndRefresh(); }
		}

		function addStationManual() {
			const n = document.getElementById('new-name').value;
			const u = document.getElementById('new-url').value;
			if(n && u) {
				stations.push({
					name: n, 
					displayName: document.getElementById('new-displayname').value || n,
					url: u,
					logo: document.getElementById('new-logo').value,
					liveArt: document.getElementById('new-art').value,
					infoUrl: document.getElementById('new-info').value
				});
				saveAndRefresh();
				alert("HinzugefÃ¼gt!");
			}
		}

		function saveAndRefresh() {
			localStorage.setItem('radio_stations', JSON.stringify(stations));
			renderStations();
			renderManagerList();
		}

		function saveSettings() {
			localStorage.setItem('radio_remember', document.getElementById('autoplay-toggle').checked);
			localStorage.setItem('radio_itunes_enabled', document.getElementById('itunes-toggle').checked);
		}

		function clearCache() {
			if(confirm("Cache leeren und App neu laden?")) {
				localStorage.clear();
				if('serviceWorker' in navigator) navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(r => r.unregister()));
				window.location.reload(true);
			}
		}

		function switchTab(t) {
			document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
			document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
			if(t==='search') { document.querySelectorAll('.tab-btn')[0].classList.add('active'); document.getElementById('tab-search').classList.add('active'); }
			else { document.querySelectorAll('.tab-btn')[1].classList.add('active'); document.getElementById('tab-manual').classList.add('active'); }
		}

		function debounceSearch() { clearTimeout(searchTimeout); searchTimeout = setTimeout(searchStations, 500); }
		function searchStations() {
			const q = document.getElementById('search-query').value; if(q.length < 3) return;
			fetch(`https://de1.api.radio-browser.info/json/stations/byname/${encodeURIComponent(q)}?limit=10`)
			.then(r => r.json()).then(d => {
				const res = document.getElementById('search-results'); res.innerHTML = '';
				d.forEach(s => {
					res.innerHTML += `<div class="search-result-item" onclick="addFromSearch('${s.name.replace(/'/g,"")}', '${s.url_resolved}', '${s.favicon}')"><img src="${s.favicon || './assets/app.png'}" class="search-result-img"><span>${s.name}</span></div>`;
				});
			});
		}
		function addFromSearch(n,u,l) { stations.push({name:n, displayName:n, url:u, logo:l}); saveAndRefresh(); alert("HinzugefÃ¼gt!"); }

		window.onclick = (e) => { if (e.target.className === 'modal') { closeSettings(); closeManager(); } }
	</script>
</body>
</html>