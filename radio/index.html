<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>heyFordy Radio</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e1e1e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="../assets/app.png">
    
    <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="assets/splash/iPhone_11__iPhone_XR_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 420px) and (device-height: 912px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="assets/splash/iPhone_Air_portrait.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 402px) and (device-height: 874px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="assets/splash/iPhone_17_Pro__iPhone_17__iPhone_16_Pro_portrait.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="assets/splash/10.2__iPad_portrait.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="assets/splash/12.9__iPad_Pro_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="assets/splash/iPhone_11__iPhone_XR_portrait.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="assets/splash/11__iPad_Pro__10.5__iPad_Pro_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 440px) and (device-height: 956px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="assets/splash/iPhone_17_Pro_Max__iPhone_16_Pro_Max_portrait.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="assets/splash/4__iPhone_SE__iPod_touch_5th_generation_and_later_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1210px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="assets/splash/11__iPad_Pro_M4_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="assets/splash/iPhone_14_Plus__iPhone_13_Pro_Max__iPhone_12_Pro_Max_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="assets/splash/iPhone_16e__iPhone_14__iPhone_13_Pro__iPhone_13__iPhone_12_Pro__iPhone_12_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="assets/splash/iPhone_13_mini__iPhone_12_mini__iPhone_11_Pro__iPhone_XS__iPhone_X_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="assets/splash/iPhone_14_Plus__iPhone_13_Pro_Max__iPhone_12_Pro_Max_portrait.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1210px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="assets/splash/11__iPad_Pro_M4_portrait.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="assets/splash/iPhone_16e__iPhone_14__iPhone_13_Pro__iPhone_13__iPhone_12_Pro__iPhone_12_portrait.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 820px) and (device-height: 1180px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="assets/splash/10.9__iPad_Air_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="assets/splash/4__iPhone_SE__iPod_touch_5th_generation_and_later_portrait.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="assets/splash/12.9__iPad_Pro_portrait.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="assets/splash/iPhone_8__iPhone_7__iPhone_6s__iPhone_6__4.7__iPhone_SE_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 1032px) and (device-height: 1376px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="assets/splash/13__iPad_Pro_M4_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 1032px) and (device-height: 1376px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="assets/splash/13__iPad_Pro_M4_portrait.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 402px) and (device-height: 874px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="assets/splash/iPhone_17_Pro__iPhone_17__iPhone_16_Pro_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="assets/splash/iPhone_11_Pro_Max__iPhone_XS_Max_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="assets/splash/iPhone_13_mini__iPhone_12_mini__iPhone_11_Pro__iPhone_XS__iPhone_X_portrait.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 420px) and (device-height: 912px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="assets/splash/iPhone_Air_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="assets/splash/iPhone_11_Pro_Max__iPhone_XS_Max_portrait.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="assets/splash/iPhone_8__iPhone_7__iPhone_6s__iPhone_6__4.7__iPhone_SE_portrait.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="assets/splash/iPhone_16_Plus__iPhone_15_Pro_Max__iPhone_15_Plus__iPhone_14_Pro_Max_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="assets/splash/8.3__iPad_Mini_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 744px) and (device-height: 1133px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="assets/splash/8.3__iPad_Mini_portrait.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="assets/splash/11__iPad_Pro__10.5__iPad_Pro_portrait.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="assets/splash/9.7__iPad_Pro__7.9__iPad_mini__9.7__iPad_Air__9.7__iPad_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="assets/splash/iPhone_16__iPhone_15_Pro__iPhone_15__iPhone_14_Pro_portrait.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="assets/splash/iPhone_16__iPhone_15_Pro__iPhone_15__iPhone_14_Pro_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="assets/splash/iPhone_8_Plus__iPhone_7_Plus__iPhone_6s_Plus__iPhone_6_Plus_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="assets/splash/10.5__iPad_Air_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="assets/splash/iPhone_8_Plus__iPhone_7_Plus__iPhone_6s_Plus__iPhone_6_Plus_portrait.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 820px) and (device-height: 1180px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="assets/splash/10.9__iPad_Air_portrait.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="assets/splash/10.2__iPad_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="assets/splash/10.5__iPad_Air_portrait.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 440px) and (device-height: 956px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)" href="assets/splash/iPhone_17_Pro_Max__iPhone_16_Pro_Max_landscape.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="assets/splash/9.7__iPad_Pro__7.9__iPad_mini__9.7__iPad_Air__9.7__iPad_portrait.png">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="assets/splash/iPhone_16_Plus__iPhone_15_Pro_Max__iPhone_15_Plus__iPhone_14_Pro_Max_portrait.png">
    <link rel="icon" type="image/png" href="../assets/icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/style.css">
    <link rel="stylesheet" href="assets/style.css">
</head>
<body>

    <header>
        <div class="header-brand">
            <i class="fa-solid fa-radio" style="margin-right: 10px;"></i>
            <span class="rainbow-text">heyFordy Radio</span>
        </div>
        <div class="header-actions">
            <button onclick="openSettings()" class="round-btn"><i class="fa-solid fa-gear"></i></button>
        </div>
    </header>

    <main>
        <div class="content-box player-container">
            <div class="cover-art-wrapper">
                <img id="player-img" src="../assets/icon.png" alt="Station Logo">
            </div>
            
            <div id="player-info">
                <div id="player-title">Wähle Sender</div>
                <div id="player-artist"></div>
            </div>
            
            <div id="player-status">Bereit</div>
            
            <audio id="audio-el" preload="none"></audio>

            <div class="controls">
                <button onclick="togglePlay()" class="play-btn">
                    <i id="play-icon" class="fa-solid fa-play"></i>
                </button>
            </div>
        </div>

        <div class="content-box">
            <div class="box-title">Meine Sender</div>
            <div id="station-list"></div>
        </div>
    </main>

    <footer>
        <a href="../index.html" class="footer-source-btn"><i class="fa-solid fa-arrow-left"></i> heyFordy.de</a>
    </footer>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn-x" onclick="closeSettings()">X</button>
            <h3 style="margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">Einstellungen</h3>
            
            <div style="background:#111; padding:15px; border-radius:8px; margin-bottom: 20px;">
                <h4 style="margin-bottom:10px; color:var(--text-muted);">Startverhalten (Autoplay)</h4>
                <select id="autoplay-select" onchange="saveAutoplaySetting()" style="width:100%; padding:10px; background:#222; border:1px solid #444; color:white; border-radius:4px; font-family:inherit;">
                    <option value="none">Kein Autoplay</option>
                    <option value="last">Zuletzt gehört</option>
                    </select>
            </div>

            <h3 style="margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">Sender verwalten</h3>
            
            <div id="settings-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 20px;"></div>
            
            <div style="background:#111; padding:15px; border-radius:8px;">
                <h4 style="margin-bottom:10px; color:var(--text-muted);">Neuer Sender</h4>
                <input type="text" id="new-name" placeholder="Name">
                <input type="text" id="new-url" placeholder="Stream URL (mp3/m3u)">
                <input type="text" id="new-logo" placeholder="Logo URL (optional)">
                <div style="text-align: right; margin-top: 10px;">
                    <button onclick="addStation()" class="modal-btn save">Speichern</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Service Worker for PWA ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker Registered'));
        }

        // --- Config & State ---
        const defaultStations = [
            {
                name: "Eldoradio",
                apiId: "eldoradio",
                url: "https://sc.bce.lu/eldo",
                logo: "https://heyfordy.de/radio/assets/eldo.lu.png"
            },
            {
                name: "RADIO BOB! Livestream National",
                apiId: "radio-bob",
                url: "https://streams.radiobob.de/bob-national/mp3-320/mediaplayer",
                logo: "https://heyfordy.de/radio/assets/radio-bob.png"
            },
            {
                name: "RTL.lu",
                apiId: "rtl.lu",
                url: "https://sc.bce.lu/rtl",
                logo: "https://heyfordy.de/radio/assets/rtl.lu.png"
            }
        ];

        let stations = JSON.parse(localStorage.getItem('radio_stations')) || defaultStations;
        let autoplaySetting = localStorage.getItem('radio_autoplay') || 'last';
        let lastPlayedIndex = parseInt(localStorage.getItem('radio_last_index')) || 0;
        
        let currentStationIndex = -1;
        let metaInterval = null;
        const audio = document.getElementById('audio-el');

        // --- Init ---
        renderStations();
        renderAutoplayOptions(); // Settings Dropdown füllen
        handleStartup(); // Check URL param or Autoplay

        // --- Startup Logic ---
        function handleStartup() {
            const urlParams = new URLSearchParams(window.location.search);
            const playParam = urlParams.get('play');

            if (playParam) {
                // 1. Priorität: URL Parameter (?play=id oder ?play=name)
                // Suche zuerst nach ID, dann nach Name (case insensitive)
                let targetIndex = stations.findIndex(s => s.apiId === playParam);
                if (targetIndex === -1) {
                    targetIndex = stations.findIndex(s => s.name.toLowerCase() === playParam.toLowerCase());
                }

                if (targetIndex !== -1) {
                    console.log("Starting via URL Param:", stations[targetIndex].name);
                    playStation(targetIndex);
                }
            } else {
                // 2. Priorität: Autoplay Einstellung
                if (autoplaySetting === 'none') return;

                let targetIndex = -1;
                if (autoplaySetting === 'last') {
                    if (lastPlayedIndex >= 0 && lastPlayedIndex < stations.length) {
                        targetIndex = lastPlayedIndex;
                    }
                } else {
                    // ID eines spezifischen Senders
                    targetIndex = stations.findIndex(s => s.apiId === autoplaySetting || s.name === autoplaySetting);
                }

                if (targetIndex !== -1) {
                    console.log("Autoplay starting:", stations[targetIndex].name);
                    playStation(targetIndex);
                }
            }
        }

        // --- Player Functions ---
        function playStation(index) {
            currentStationIndex = index;
            // Save Last Played
            localStorage.setItem('radio_last_index', index);
            
            const s = stations[index];
            
            // UI Reset
            document.getElementById('player-title').innerText = s.name;
            document.getElementById('player-artist').innerText = "";
            document.getElementById('player-status').innerText = "Verbinde...";
            document.getElementById('player-img').src = s.logo || '../assets/icon.png';
            
            // Highlight list
            document.querySelectorAll('.station-item').forEach((el, i) => {
                el.classList.toggle('active', i === index);
            });

            // Audio Setup
            audio.src = s.url;
            audio.play().then(() => {
                updatePlayBtn(true);
                document.getElementById('player-status').innerText = "LIVE";
                
                // Start polling API
                startMetaFetcher(s);
                
                updateMediaSession(s.name, "Live Radio", s.logo);
            }).catch(e => {
                console.error("Playback failed (Autoplay blocked?):", e);
                updatePlayBtn(false);
                document.getElementById('player-status').innerText = "Bereit (Tippen zum Starten)";
                // Trotz Fehler (Blockierung) Metadaten laden, damit UI aktuell ist
                startMetaFetcher(s); 
            });
        }

        function togglePlay() {
            if (!audio.src && currentStationIndex !== -1) {
                // Falls src weg ist aber ein Sender gewählt war (Edge Case), neu laden
                playStation(currentStationIndex);
                return;
            }
            if (!audio.src) return;

            if (audio.paused) {
                audio.play();
                updatePlayBtn(true);
                document.getElementById('player-status').innerText = "LIVE";
            } else {
                audio.pause();
                updatePlayBtn(false);
                document.getElementById('player-status').innerText = "PAUSE";
            }
        }

        function updatePlayBtn(isPlaying) {
            const icon = document.getElementById('play-icon');
            icon.className = isPlaying ? 'fa-solid fa-pause' : 'fa-solid fa-play';
        }

        // --- Metadata & Cover Logic ---
        function startMetaFetcher(station) {
            if (metaInterval) clearInterval(metaInterval);
            
            const fetchInfo = () => {
                // Nur wenn Sender eine apiId hat (Standard-Sender)
                if (station.apiId) {
                    fetch('https://api.heyfordy.de/radio')
                        .then(r => r.json())
                        .then(data => {
                            // Finde den Sender im Array
                            const stationData = data.find(item => item.id === station.apiId);
                            
                            if (stationData && stationData.playing) {
                                const rawTitle = stationData.playing;
                                const stationLogo = stationData.logo || station.logo;

                                // Basic UI Update Text
                                updateUIText(rawTitle, station.name);

                                // iTunes Cover Fetch
                                fetchItunesCover(rawTitle, stationLogo).then(coverUrl => {
                                    const finalCover = coverUrl || stationLogo || '../assets/icon.png';
                                    
                                    // Update Image
                                    const imgEl = document.getElementById('player-img');
                                    if(imgEl.src !== finalCover) imgEl.src = finalCover;

                                    // Update MediaSession
                                    updateMediaSession(rawTitle, station.name, finalCover);
                                });
                            }
                        })
                        .catch(err => console.log("API Fetch Error:", err));
                } else {
                    // Custom Sender ohne API
                    updateMediaSession(station.name, "Live Stream", station.logo);
                }
            };

            fetchInfo(); // Initial call
            metaInterval = setInterval(fetchInfo, 10000); // Alle 10s aktualisieren
        }

        async function fetchItunesCover(trackInfo, fallbackLogo) {
            if (!trackInfo) return fallbackLogo;
            try {
                let cleanTerm = trackInfo
                    .replace(/['"]/g, '')       // Entfernt ' und "
                    .replace(/[-]/g, ' ')       // Bindestriche zu Leerzeichen
                    .replace(/\s+/g, ' ')       // Doppelte Leerzeichen weg
                    .trim();

                const encodedTerm = encodeURIComponent(cleanTerm);
                const url = `https://itunes.apple.com/search?term=${encodedTerm}&entity=album&limit=1`;
                
                const res = await fetch(url);
                const data = await res.json();

                if (data.resultCount > 0 && data.results[0].artworkUrl100) {
                    let artUrl = data.results[0].artworkUrl100;
                    return artUrl.replace('100x100bb', '512x512bb');
                }
            } catch (e) {
                console.warn("iTunes Fetch failed:", e);
            }
            return fallbackLogo;
        }

        function updateUIText(rawTitle, stationName) {
            if (rawTitle.includes(' - ')) {
                const parts = rawTitle.split(' - ');
                document.getElementById('player-title').innerText = parts[1] || parts[0];
                document.getElementById('player-artist').innerText = parts[0];
            } else {
                document.getElementById('player-title').innerText = rawTitle;
                document.getElementById('player-artist').innerText = stationName;
            }
        }

        function updateMediaSession(title, artist, artworkUrl) {
            if ('mediaSession' in navigator) {
                let displayTitle = title;
                let displayArtist = artist;
                
                if (title.includes(' - ')) {
                    const parts = title.split(' - ');
                    displayArtist = parts[0];
                    displayTitle = parts[1] || "";
                }

                navigator.mediaSession.metadata = new MediaMetadata({
                    title: displayTitle,
                    artist: displayArtist,
                    artwork: [
                        { src: artworkUrl || '../assets/icon.png', sizes: '512x512', type: 'image/png' }
                    ]
                });
                
                navigator.mediaSession.setActionHandler('play', () => { audio.play(); updatePlayBtn(true); });
                navigator.mediaSession.setActionHandler('pause', () => { audio.pause(); updatePlayBtn(false); });
            }
        }

        // --- Rendering ---
        function renderStations() {
            const list = document.getElementById('station-list');
            const sett = document.getElementById('settings-list');
            list.innerHTML = '';
            sett.innerHTML = '';

            stations.forEach((s, i) => {
                // Main List
                const logo = s.logo || '../assets/icon.png';
                list.innerHTML += `
                    <div class="station-item" onclick="playStation(${i})">
                        <img src="${logo}" class="station-logo" onerror="this.src='../assets/icon.png'">
                        <div class="station-info">
                            <span class="station-name">${s.name}</span>
                        </div>
                        <i class="fa-solid fa-play" style="opacity:0.5;"></i>
                    </div>
                `;

                // Settings List
                sett.innerHTML += `
                    <div class="settings-item">
                        <div style="overflow:hidden;">
                            <strong>${s.name}</strong><br>
                            <span style="font-size:0.8rem; color:#888;">${s.url}</span>
                        </div>
                        <i class="fa-solid fa-trash delete-icon" onclick="removeStation(${i})"></i>
                    </div>
                `;
            });
            
            renderAutoplayOptions();
        }

        function renderAutoplayOptions() {
            const select = document.getElementById('autoplay-select');
            // Keep first 2 options (none, last)
            select.innerHTML = `
                <option value="none" ${autoplaySetting === 'none' ? 'selected' : ''}>Kein Autoplay</option>
                <option value="last" ${autoplaySetting === 'last' ? 'selected' : ''}>Zuletzt gehört</option>
            `;
            
            stations.forEach(s => {
                // Use API ID if available, else Name as value
                const val = s.apiId || s.name;
                const isSelected = (autoplaySetting === val);
                select.innerHTML += `<option value="${val}" ${isSelected ? 'selected' : ''}>${s.name}</option>`;
            });
        }

        // --- Settings ---
        function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
        
        function saveAutoplaySetting() {
            autoplaySetting = document.getElementById('autoplay-select').value;
            localStorage.setItem('radio_autoplay', autoplaySetting);
        }

        function addStation() {
            const name = document.getElementById('new-name').value;
            const url = document.getElementById('new-url').value;
            const logo = document.getElementById('new-logo').value;

            if (name && url) {
                stations.push({ name, url, logo });
                save();
                // Clear inputs
                ['new-name', 'new-url', 'new-logo'].forEach(id => document.getElementById(id).value = '');
                renderStations();
            }
        }

        function removeStation(index) {
            if(confirm("Sender löschen?")) {
                stations.splice(index, 1);
                save();
                renderStations();
            }
        }

        function save() { localStorage.setItem('radio_stations', JSON.stringify(stations)); }

        window.onclick = (e) => {
            if (e.target == document.getElementById('settings-modal')) closeSettings();
        }
    </script>
</body>
</html>