<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>heyFordy Radio</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e1e1e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="../assets/icon.png">
    
    <link rel="apple-touch-startup-image" href="../assets/icon.png">

    <link rel="icon" type="image/png" href="../assets/icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/style.css">
    <link rel="stylesheet" href="assets/style.css">
</head>
<body>

    <header>
        <div class="header-brand">
            <i class="fa-solid fa-radio" style="margin-right: 10px;"></i>
            <span class="rainbow-text">heyFordy Radio</span>
        </div>
        <div class="header-actions">
            <button onclick="openSettings()" class="round-btn"><i class="fa-solid fa-gear"></i></button>
        </div>
    </header>

    <main>
        <div class="content-box player-container">
            <div class="cover-art-wrapper">
                <img id="player-img" src="../assets/icon.png" alt="Station Logo">
            </div>
            
            <div id="player-info">
                <div id="player-title">Wähle Sender</div>
                <div id="player-artist"></div>
            </div>
            
            <div id="player-status">Bereit</div>
            
            <audio id="audio-el" preload="none"></audio>

            <div class="controls">
                <button onclick="togglePlay()" class="play-btn">
                    <i id="play-icon" class="fa-solid fa-play"></i>
                </button>
            </div>
        </div>

        <div class="content-box">
            <div class="box-title">Meine Sender</div>
            <div id="station-list"></div>
        </div>
    </main>

    <footer>
        <a href="../index.html" class="footer-source-btn"><i class="fa-solid fa-arrow-left"></i> heyFordy.de</a>
    </footer>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn-x" onclick="closeSettings()">X</button>
            <h3 style="margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">Sender verwalten</h3>
            
            <div id="settings-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 20px;"></div>
            
            <div style="background:#111; padding:15px; border-radius:8px;">
                <h4 style="margin-bottom:10px; color:var(--text-muted);">Neuer Sender</h4>
                <input type="text" id="new-name" placeholder="Name">
                <input type="text" id="new-url" placeholder="Stream URL (mp3/m3u)">
                <input type="text" id="new-logo" placeholder="Logo URL (optional)">
                <div style="text-align: right; margin-top: 10px;">
                    <button onclick="addStation()" class="modal-btn save">Speichern</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Service Worker for PWA ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker Registered'));
        }

        // --- Config & State ---
        const defaultStations = [
            {
                name: "Eldoradio",
                apiId: "eldoradio",
                url: "https://sc.bce.lu/eldo",
                logo: "https://heyfordy.de/radio/assets/eldo.lu.png"
            },
            {
                name: "RADIO BOB! Livestream National",
                apiId: "radio-bob",
                url: "https://streams.radiobob.de/bob-national/mp3-320/mediaplayer",
                logo: "https://heyfordy.de/radio/assets/radio-bob.png"
            },
            {
                name: "RTL.lu",
                apiId: "rtl.lu",
                url: "https://sc.bce.lu/rtl",
                logo: "https://heyfordy.de/radio/assets/rtl.lu.png"
            }
        ];

        let stations = JSON.parse(localStorage.getItem('radio_stations')) || defaultStations;
        let currentStationIndex = -1;
        let metaInterval = null;
        const audio = document.getElementById('audio-el');

        // --- Init ---
        renderStations();

        // --- Player Functions ---
        function playStation(index) {
            currentStationIndex = index;
            const s = stations[index];
            
            // UI Reset
            document.getElementById('player-title').innerText = s.name;
            document.getElementById('player-artist').innerText = "";
            document.getElementById('player-status').innerText = "Verbinde...";
            document.getElementById('player-img').src = s.logo || '../assets/icon.png';
            
            // Highlight list
            document.querySelectorAll('.station-item').forEach((el, i) => {
                el.classList.toggle('active', i === index);
            });

            // Audio Setup
            audio.src = s.url;
            audio.play().then(() => {
                updatePlayBtn(true);
                document.getElementById('player-status').innerText = "LIVE";
                
                // Start polling API
                startMetaFetcher(s);
                
                updateMediaSession(s.name, "Live Radio", s.logo);
            }).catch(e => {
                console.error(e);
                document.getElementById('player-status').innerText = "Fehler (Stream offline?)";
            });
        }

        function togglePlay() {
            if (!audio.src) return;
            if (audio.paused) {
                audio.play();
                updatePlayBtn(true);
            } else {
                audio.pause();
                updatePlayBtn(false);
            }
        }

        function updatePlayBtn(isPlaying) {
            const icon = document.getElementById('play-icon');
            icon.className = isPlaying ? 'fa-solid fa-pause' : 'fa-solid fa-play';
        }

        // --- Metadata & Cover Logic ---
        function startMetaFetcher(station) {
            if (metaInterval) clearInterval(metaInterval);
            
            const fetchInfo = () => {
                // Nur wenn Sender eine apiId hat (Standard-Sender)
                if (station.apiId) {
                    fetch('https://api.heyfordy.de/radio')
                        .then(r => r.json())
                        .then(data => {
                            // Finde den Sender im Array
                            const stationData = data.find(item => item.id === station.apiId);
                            
                            if (stationData && stationData.playing) {
                                const rawTitle = stationData.playing; // "Artist - Title"
                                const stationLogo = stationData.logo || station.logo;

                                // Basic UI Update Text
                                updateUIText(rawTitle, station.name);

                                // iTunes Cover Fetch
                                fetchItunesCover(rawTitle, stationLogo).then(coverUrl => {
                                    const finalCover = coverUrl || stationLogo || '../assets/icon.png';
                                    
                                    // Update Image
                                    const imgEl = document.getElementById('player-img');
                                    if(imgEl.src !== finalCover) imgEl.src = finalCover;

                                    // Update MediaSession
                                    updateMediaSession(rawTitle, station.name, finalCover);
                                });
                            }
                        })
                        .catch(err => console.log("API Fetch Error:", err));
                } else {
                    // Custom Sender ohne API
                    updateMediaSession(station.name, "Live Stream", station.logo);
                }
            };

            fetchInfo(); // Initial call
            metaInterval = setInterval(fetchInfo, 10000); // Alle 10s aktualisieren
        }

        // Hilfsfunktion: iTunes Cover laden
        async function fetchItunesCover(trackInfo, fallbackLogo) {
            if (!trackInfo) return fallbackLogo;

            // 1. String bereinigen: "-" entfernen, Leerzeichen durch "+" ersetzen
            // Wir entfernen Bindestriche und ersetzen ALLE Leerzeichen durch Plus
            const cleanTerm = trackInfo.replace(/-/g, '').replace(/\s+/g, '+');
            
            const url = `https://itunes.apple.com/search?term=${cleanTerm}&entity=album&limit=1`;

            try {
                const res = await fetch(url);
                const data = await res.json();

                if (data.resultCount > 0 && data.results[0].artworkUrl100) {
                    let artUrl = data.results[0].artworkUrl100;
                    // 100x100 durch 512x512 ersetzen für bessere Qualität
                    return artUrl.replace('100x100bb', '512x512bb');
                }
            } catch (e) {
                console.warn("iTunes Fetch failed:", e);
            }
            return fallbackLogo;
        }

        function updateUIText(rawTitle, stationName) {
            // Wir versuchen Artist und Titel zu trennen für eine schönere Anzeige,
            // falls ein Bindestrich vorhanden ist.
            if (rawTitle.includes(' - ')) {
                const parts = rawTitle.split(' - ');
                document.getElementById('player-title').innerText = parts[1] || parts[0];
                document.getElementById('player-artist').innerText = parts[0];
            } else {
                document.getElementById('player-title').innerText = rawTitle;
                document.getElementById('player-artist').innerText = stationName;
            }
        }

        function updateMediaSession(title, artist, artworkUrl) {
            if ('mediaSession' in navigator) {
                // Falls Title "Artist - Song" ist, splitten wir es für die MediaSession Metadaten
                let displayTitle = title;
                let displayArtist = artist;
                
                if (title.includes(' - ')) {
                    const parts = title.split(' - ');
                    displayArtist = parts[0];
                    displayTitle = parts[1] || "";
                }

                navigator.mediaSession.metadata = new MediaMetadata({
                    title: displayTitle,
                    artist: displayArtist,
                    artwork: [
                        { src: artworkUrl || '../assets/icon.png', sizes: '512x512', type: 'image/png' }
                    ]
                });
                
                navigator.mediaSession.setActionHandler('play', () => { audio.play(); updatePlayBtn(true); });
                navigator.mediaSession.setActionHandler('pause', () => { audio.pause(); updatePlayBtn(false); });
            }
        }

        // --- Rendering ---
        function renderStations() {
            const list = document.getElementById('station-list');
            const sett = document.getElementById('settings-list');
            list.innerHTML = '';
            sett.innerHTML = '';

            stations.forEach((s, i) => {
                // Main List
                const logo = s.logo || '../assets/icon.png';
                list.innerHTML += `
                    <div class="station-item" onclick="playStation(${i})">
                        <img src="${logo}" class="station-logo" onerror="this.src='../assets/icon.png'">
                        <div class="station-info">
                            <span class="station-name">${s.name}</span>
                        </div>
                        <i class="fa-solid fa-play" style="opacity:0.5;"></i>
                    </div>
                `;

                // Settings List
                sett.innerHTML += `
                    <div class="settings-item">
                        <div style="overflow:hidden;">
                            <strong>${s.name}</strong><br>
                            <span style="font-size:0.8rem; color:#888;">${s.url}</span>
                        </div>
                        <i class="fa-solid fa-trash delete-icon" onclick="removeStation(${i})"></i>
                    </div>
                `;
            });
        }

        // --- Settings ---
        function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }

        function addStation() {
            const name = document.getElementById('new-name').value;
            const url = document.getElementById('new-url').value;
            const logo = document.getElementById('new-logo').value;

            if (name && url) {
                stations.push({ name, url, logo });
                save();
                // Clear inputs
                ['new-name', 'new-url', 'new-logo'].forEach(id => document.getElementById(id).value = '');
                renderStations();
            }
        }

        function removeStation(index) {
            if(confirm("Sender löschen?")) {
                stations.splice(index, 1);
                save();
                renderStations();
            }
        }

        function save() { localStorage.setItem('radio_stations', JSON.stringify(stations)); }

        window.onclick = (e) => {
            if (e.target == document.getElementById('settings-modal')) closeSettings();
        }
    </script>
</body>
</html>