<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>heyFordy Radio</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e1e1e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="../assets/icon.png">
    
    <link rel="apple-touch-startup-image" href="../assets/icon.png">

    <link rel="icon" type="image/png" href="../assets/icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/style.css">
    <link rel="stylesheet" href="assets/style.css">
</head>
<body>

    <header>
        <div class="header-brand">
            <i class="fa-solid fa-radio" style="margin-right: 10px;"></i>
            <span class="rainbow-text">heyFordy Radio</span>
        </div>
        <div class="header-actions">
            <button onclick="openSettings()" class="round-btn"><i class="fa-solid fa-gear"></i></button>
        </div>
    </header>

    <main>
        <div class="content-box player-container">
            <div class="cover-art-wrapper">
                <img id="player-img" src="../assets/icon.png" alt="Station Logo">
            </div>
            
            <div id="player-info">
                <div id="player-title">Wähle Sender</div>
                <div id="player-artist"></div>
            </div>
            
            <div id="player-status">Bereit</div>
            
            <audio id="audio-el" preload="none"></audio>

            <div class="controls">
                <button onclick="togglePlay()" class="play-btn">
                    <i id="play-icon" class="fa-solid fa-play"></i>
                </button>
            </div>
        </div>

        <div class="content-box">
            <div class="box-title">Meine Sender</div>
            <div id="station-list"></div>
        </div>
    </main>

    <footer>
        <a href="../index.html" class="footer-source-btn"><i class="fa-solid fa-arrow-left"></i> heyFordy.de</a>
    </footer>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn-x" onclick="closeSettings()">X</button>
            <h3 style="margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">Sender verwalten</h3>
            
            <div id="settings-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 20px;"></div>
            
            <div style="background:#111; padding:15px; border-radius:8px;">
                <h4 style="margin-bottom:10px; color:var(--text-muted);">Neuer Sender</h4>
                <input type="text" id="new-name" placeholder="Name">
                <input type="text" id="new-url" placeholder="Stream URL (mp3/m3u)">
                <input type="text" id="new-logo" placeholder="Logo URL (optional)">
                <div style="text-align: right; margin-top: 10px;">
                    <button onclick="addStation()" class="modal-btn save">Speichern</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Service Worker for PWA ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker Registered'));
        }

        // --- Config & State ---
        // Mapping für die API-Keys der Standardsender
        const apiKeys = {
            "RADIO BOB! Livestream National": "radio-bob",
            "Eldoradio": "eldoradio"
        };

        const defaultStations = [
            {
                name: "RADIO BOB! Livestream National",
                url: "https://streams.radiobob.de/bob-national/mp3-320/mediaplayer",
                logo: "https://cdn-profiles.tunein.com/s323217/images/logod.jpg?t=638126635790000000"
            },
            {
                name: "Eldoradio",
                url: "https://sc.bce.lu/eldo",
                logo: "https://play-lh.googleusercontent.com/kjC3uu-gR5wt5jMqhpHKRPq2ZTsA5M3UIX8cZZfq-sEKRQTLTj5oSMRDioK5eDOkTi5O"
            }
        ];

        let stations = JSON.parse(localStorage.getItem('radio_stations')) || defaultStations;
        let currentStationIndex = -1;
        let metaInterval = null;
        const audio = document.getElementById('audio-el');

        // --- Init ---
        renderStations();

        // --- Player Functions ---
        function playStation(index) {
            currentStationIndex = index;
            const s = stations[index];
            
            // UI Reset
            document.getElementById('player-title').innerText = s.name;
            document.getElementById('player-artist').innerText = "";
            document.getElementById('player-status').innerText = "Verbinde...";
            
            // Check if we have an API override for the logo initially, otherwise default
            document.getElementById('player-img').src = s.logo || '../assets/icon.png';
            
            // Highlight list
            document.querySelectorAll('.station-item').forEach((el, i) => {
                el.classList.toggle('active', i === index);
            });

            // Audio Setup
            audio.src = s.url;
            audio.play().then(() => {
                updatePlayBtn(true);
                document.getElementById('player-status').innerText = "LIVE";
                
                // Start polling API for defaults or basic meta for custom
                startMetaFetcher(s);
                
                // Initial Media Session (will be updated by fetcher)
                updateMediaSession(s.name, "Live Radio", s.logo);
            }).catch(e => {
                console.error(e);
                document.getElementById('player-status').innerText = "Fehler (Stream offline?)";
            });
        }

        function togglePlay() {
            if (!audio.src) return;
            if (audio.paused) {
                audio.play();
                updatePlayBtn(true);
            } else {
                audio.pause();
                updatePlayBtn(false);
            }
        }

        function updatePlayBtn(isPlaying) {
            const icon = document.getElementById('play-icon');
            icon.className = isPlaying ? 'fa-solid fa-pause' : 'fa-solid fa-play';
        }

        // --- Metadata Logic ---
        function startMetaFetcher(station) {
            if (metaInterval) clearInterval(metaInterval);
            
            const fetchInfo = () => {
                const apiKey = apiKeys[station.name];

                if (apiKey) {
                    // Logik für Standard-Sender (API nutzen)
                    Promise.all([
                        fetch('https://api.heyfordy.de/radio').then(r => r.json()).catch(() => null),
                        fetch('https://api.heyfordy.de/radio-img').then(r => r.json()).catch(() => null)
                    ]).then(([textData, imgData]) => {
                        let title = station.name;
                        let artist = "Live Radio";
                        let currentLogo = station.logo;

                        // 1. Title/Artist Logic
                        if (textData && textData[apiKey]) {
                            const rawTitle = textData[apiKey];
                            const lowerTitle = rawTitle.toLowerCase();
                            
                            // Check for blocked strings
                            if (lowerTitle.includes("radio bob") || lowerTitle.includes("eldoradio")) {
                                title = station.name;
                                artist = "heyFordy's Radio";
                            } else {
                                title = rawTitle; // "Titel aus API"
                                artist = station.name; // "Sendername"
                            }
                        }

                        // 2. Image Logic
                        if (imgData && imgData[apiKey]) {
                            currentLogo = imgData[apiKey];
                        }

                        // Update UI
                        document.getElementById('player-title').innerText = title;
                        document.getElementById('player-artist').innerText = artist;
                        const imgEl = document.getElementById('player-img');
                        if(imgEl.src !== currentLogo) imgEl.src = currentLogo || '../assets/icon.png';

                        // Update MediaSession
                        updateMediaSession(title, artist, currentLogo);
                    });

                } else {
                    // Logik für Custom Sender
                    // Wir nutzen den Sendernamen als Titel, da wir ICY-Tags nicht via JS lesen können (CORS).
                    // Wenn der Browser native Tags erkennt, zeigt er sie im OS an, 
                    // aber wir setzen hier den Fallback für die UI.
                    document.getElementById('player-title').innerText = station.name;
                    document.getElementById('player-artist').innerText = "Live Stream";
                    
                    // Reset Logo to station default
                    document.getElementById('player-img').src = station.logo || '../assets/icon.png';
                    
                    updateMediaSession(station.name, "Live Stream", station.logo);
                }
            };

            fetchInfo(); // Initial call
            metaInterval = setInterval(fetchInfo, 10000); // Alle 10s aktualisieren
        }

        function updateMediaSession(title, artist, artworkUrl) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: title,
                    artist: artist,
                    artwork: [
                        { src: artworkUrl || '../assets/icon.png', sizes: '512x512', type: 'image/png' }
                    ]
                });
                
                navigator.mediaSession.setActionHandler('play', () => { audio.play(); updatePlayBtn(true); });
                navigator.mediaSession.setActionHandler('pause', () => { audio.pause(); updatePlayBtn(false); });
            }
        }

        // --- Rendering ---
        function renderStations() {
            const list = document.getElementById('station-list');
            const sett = document.getElementById('settings-list');
            list.innerHTML = '';
            sett.innerHTML = '';

            stations.forEach((s, i) => {
                // Main List
                const logo = s.logo || '../assets/icon.png';
                list.innerHTML += `
                    <div class="station-item" onclick="playStation(${i})">
                        <img src="${logo}" class="station-logo" onerror="this.src='../assets/icon.png'">
                        <div class="station-info">
                            <span class="station-name">${s.name}</span>
                        </div>
                        <i class="fa-solid fa-play" style="opacity:0.5;"></i>
                    </div>
                `;

                // Settings List
                sett.innerHTML += `
                    <div class="settings-item">
                        <div style="overflow:hidden;">
                            <strong>${s.name}</strong><br>
                            <span style="font-size:0.8rem; color:#888;">${s.url}</span>
                        </div>
                        <i class="fa-solid fa-trash delete-icon" onclick="removeStation(${i})"></i>
                    </div>
                `;
            });
        }

        // --- Settings ---
        function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }

        function addStation() {
            const name = document.getElementById('new-name').value;
            const url = document.getElementById('new-url').value;
            const logo = document.getElementById('new-logo').value;
            
            // Meta URL ignoriert/entfernt wie angefordert

            if (name && url) {
                stations.push({ name, url, logo });
                save();
                // Clear inputs
                ['new-name', 'new-url', 'new-logo'].forEach(id => document.getElementById(id).value = '');
                renderStations();
            }
        }

        function removeStation(index) {
            if(confirm("Sender löschen?")) {
                stations.splice(index, 1);
                save();
                renderStations();
            }
        }

        function save() { localStorage.setItem('radio_stations', JSON.stringify(stations)); }

        // Close on outside click
        window.onclick = (e) => {
            if (e.target == document.getElementById('settings-modal')) closeSettings();
        }
    </script>
</body>
</html>